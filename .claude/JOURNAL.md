# Claude Code Journal

This journal tracks substantive work on documents, diagrams, and documentation content.

---

1. **Task - Project initialization** (v0.1.0): Initialized jupyterlab_kernel_terminal_workspace_culler_extension as a new JupyterLab extension project with Claude Code configuration<br>
   **Result**: Created `.claude/CLAUDE.md` with workspace import directive linking to `/home/lab/workspace/.claude/CLAUDE.md`, reinforcing mandatory bans for git operations and package management. Created `.claude/JOURNAL.md` for tracking substantive work. Updated README.md with standardized badges (GitHub Actions, npm, PyPI, downloads, JupyterLab 4, KOLOMOLO, PayPal) and concise feature list. Extension provides automatic culling of idle kernels, terminals, and workspaces with configurable timeout settings. Project uses TypeScript frontend with Python server extension targeting JupyterLab 4.x.

2. **Task - Culler implementation** (v0.1.1): Implemented server-side resource culler with frontend settings sync and notification support<br>
   **Result**: Created `culler.py` with `ResourceCuller` class using tornado's `PeriodicCallback` for scheduled culling of idle kernels, terminals, and sessions. Implemented `_cull_kernels()` checking execution_state and last_activity, `_cull_terminals()` parsing datetime from terminal manager list, and `_cull_sessions()` checking associated kernel activity. All culling logged at INFO level with `[Culler]` prefix. Updated `routes.py` with three handlers: `SettingsHandler` (POST `/settings`) for frontend settings sync with camelCase to snake_case conversion, `StatusHandler` (GET `/status`) returning running state and current settings, `CullResultHandler` (GET `/cull-result`) returning consumed-once culling results for notification polling. Updated `__init__.py` to instantiate `ResourceCuller` with server_app reference and call `start()` on extension load. Updated `schema/plugin.json` with 8 configurable settings: kernelCullEnabled (default true), kernelCullIdleTimeout (60 min), terminalCullEnabled (true), terminalCullIdleTimeout (30 min), sessionCullEnabled (false), sessionCullIdleTimeout (120 min), cullCheckInterval (5 min), showNotifications (true). Updated `src/index.ts` with `syncSettings()` posting composite settings on load and change, and `pollCullResults()` polling `/cull-result` every 30 seconds - if resources were culled and showNotifications enabled, displays notification via jupyterlab-notifications-extension command or falls back to console.info. Created `tests/test_culler.py` with pytest-asyncio tests covering default settings verification, settings update with camelCase mapping, idle kernel culling with execution_state and last_activity checks, busy kernel skipping, active kernel skipping, idle terminal culling, terminal with ISO string timestamps, and cull result consumption tracking. Build successful at v0.1.1, all frontend tests pass.

3. **Task - Bugfixes and CI/CD** (v0.1.8): Fixed terminal manager access, notification formatting, updated defaults, added documentation and CI/CD workflows<br>
   **Result**: Fixed terminal culling failure in JupyterHub environments where `terminal_manager` is not directly on server_app - added fallback to `web_app.settings.get("terminal_manager")` in `culler.py`. Fixed notification display showing literal `<br>` tags by changing to `\n` newlines in `src/index.ts`. Added `skipLibCheck: true` to `tsconfig.json` to resolve lib0 TypeScript declaration errors with newer TS versions. Updated default timeouts: kernel 60min (1h), terminal 60min (1h), session 10080min (7d). Comprehensive README update with Default Settings table, How Idle Detection Works section explaining kernel/terminal/session activity tracking, and FAQ section covering long-running calculations (recommending `screen`/`tmux` or increasing timeouts), browser tab behavior, `nohup` process survival, disabling culling, and viewing cull logs. Created `.github/workflows/` with five CI/CD workflows following JUPYTERLAB_EXTENSION.md guidelines: `build.yml` for build/test/package on push/PR with link checking, `check-release.yml` for release readiness verification, `prep-release.yml` for manual release preparation, `publish-release.yml` for npm/PyPI publishing, and `enforce-label.yml` for PR label enforcement. All workflows configured with `steps_to_skip: "build-changelog"` and `RH_SINCE_LAST_STABLE: 'true'` for direct commit workflow compatibility.

4. **Task - CI URL fixes** (v0.1.9): Fixed malformed GitHub URLs in package.json causing CI check-npm failure<br>
   **Result**: CI `check-release.yml` workflow failed at check-npm step with ValueError indicating repository.url doesn't match cloned repository. Found three malformed URLs in `package.json`: homepage had trailing `.git`, bugs.url had `.git/issues` path, and repository.url had duplicate `.git.git` suffix. Fixed all three URLs - homepage and bugs.url now use bare GitHub URLs without `.git`, repository.url uses single `.git` suffix. Build and tests pass. CI should now validate successfully.

5. **Task - Disconnected-only terminal culling** (v1.0.4): Added setting to only cull terminals without active browser connections<br>
   **Result**: Added `terminalCullDisconnectedOnly` setting (default: true) to `schema/plugin.json`. Updated `culler.py` with `_terminal_has_connected_clients()` helper method that checks terminado's internal `terminals` dict and `clients` set to detect active WebSocket connections. Modified `_cull_terminals()` to skip terminals with connected clients when setting enabled - terminals with open browser tabs are preserved regardless of idle time. Updated `README.md` Default Settings table and How Idle Detection Works section to document the new behavior. Also added `jupyterlab-notifications-extension` as optional dependency in `pyproject.toml`, created `CHANGELOG.md` with version history, and published v1.0.3 to npm/PyPI.

6. **Task - CLI implementation** (v1.0.5): Created command-line tool for listing and culling resources from terminal<br>
   **Result**: Created `cli.py` with `jupyterlab_kernel_terminal_workspace_culler` command supporting two subcommands: `list` (displays all resources with idle times, culler settings, and terminal connection status) and `cull` (executes culling with optional `--dry-run` simulation). Added `--json` flag for machine-readable output. Implemented `JupyterClient` class for REST API communication with auto-detection of running Jupyter servers via `jupyter server list --json`. Token priority follows JupyterHub pattern: `JUPYTERHUB_API_TOKEN` -> `JPY_API_TOKEN` -> `JUPYTER_TOKEN` -> token from server list. Added `get_terminals_connection_status()` method to `culler.py` exposing terminal WebSocket connection status. Created `TerminalsConnectionHandler` in `routes.py` for `/terminals-connection` endpoint. CLI output shows culler settings first, then kernels with execution_state and idle time, terminals with connected/disconnected flag and idle time, and sessions with kernel state and idle time. Added entry point in `pyproject.toml` and `requests>=2.20.0` dependency. Updated `README.md` with CLI documentation section.

7. **Task - Frontend terminal tracking** (v1.0.15): Fixed disconnected-only terminal culling by implementing frontend-to-backend active terminal tab reporting<br>
   **Result**: The `terminalCullDisconnectedOnly` setting was not working - all terminals showed as "connected" even when their tabs were closed. Investigation revealed the root cause: JupyterLab intentionally keeps WebSocket connections alive after tab close to support reconnection. The backend's `_terminal_has_connected_clients()` checked terminado's `term.clients` list and `stream.closed()`, but both always indicated active connections regardless of tab state. The backend cannot detect frontend tab visibility - only the frontend knows which terminals have open `MainAreaWidget<Terminal>` instances.

   **Architecture**: Frontend tracks open terminal widgets via JupyterLab's `ITerminalTracker` and reports active terminal names to backend via POST `/active-terminals`. Backend stores this in `_active_terminals: set[str]` and uses `_terminal_has_active_tab(name)` during culling decisions. Event handlers (`currentChanged`, `widgetAdded`) provide immediate updates when tabs open/close. A periodic callback using the configurable `cullCheckInterval` setting serves as backup for edge cases like visibility changes not triggering events.

   **Backend changes** (`culler.py`): Added `_active_terminals` set field, `set_active_terminals(terminals: list[str])` method, `_terminal_has_active_tab(name: str)` method. Modified `_cull_terminals()` to call `_terminal_has_active_tab()` instead of `_terminal_has_connected_clients()`. Updated `get_terminals_connection_status()` for CLI to use active tab tracking. Removed unused `_terminal_has_connected_clients()`.

   **Backend changes** (`routes.py`): Added `ActiveTerminalsHandler` class handling POST requests with JSON body `{"terminals": ["1", "3"]}`. Removed temporary `TerminalsDebugHandler`. Registered `/active-terminals` route.

   **Frontend changes** (`src/index.ts`): Added `ITerminalTracker` as optional dependency, added `@jupyterlab/terminal` to `package.json`. Created `reportActiveTerminals(tracker)` function that iterates tracked widgets, collects names where `widget.isVisible && widget.isAttached && !widget.isDisposed`, and POSTs to backend. Connected to `terminalTracker.currentChanged` and `terminalTracker.widgetAdded` signals for immediate reporting. Added `setupIntervals()` function managing periodic callbacks for both terminal reporting and cull results polling - both now use the same configurable `cullCheckInterval` setting. Intervals restart when setting changes.

8. **Task - Replace sessions with workspaces** (v1.0.18): Replaced session culling with workspace culling throughout the extension<br>
   **Result**: User clarified that "sessions" (kernel-notebook associations) were not the intended culling target - the extension should cull JupyterLab workspaces (auto-0, auto-k, default, etc.) instead. These are UI state files stored in `~/.jupyter/lab/workspaces/` created when users open multiple browser windows. Updated `culler.py` with `workspace_manager` property using `jupyterlab_server.workspaces_handler.WorkspacesManager` initialized with `~/.jupyter/lab/workspaces/` path, `list_workspaces()` returning workspace metadata, and `_cull_workspaces()` checking `last_modified` timestamp against timeout - default workspace is protected and never culled. Updated `routes.py` with `WorkspacesHandler` for GET `/workspaces` endpoint and changed `CullResultHandler` to return `workspaces_culled`. Updated `schema/plugin.json` renaming `sessionCullEnabled` -> `workspaceCullEnabled` and `sessionCullIdleTimeout` -> `workspaceCullIdleTimeout` with descriptions noting default workspace protection. Updated `cli.py` replacing session listing with workspace listing via extension's `/workspaces` endpoint, showing protected indicator for default workspace. Updated `src/index.ts` changing `pollCullResults()` to expect `workspaces_culled` and notification output to show "Workspaces". Updated `README.md` with workspace culling documentation including disabled-by-default setting, 7-day timeout, and `last_modified` timestamp behavior.
